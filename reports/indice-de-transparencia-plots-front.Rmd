---
title: "Índices para o site"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    float: true
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.height = 8,
                      fig.width = 9)

set.seed(1014)
options(digits = 2, scipen = 999, OutDec = ",")
Sys.setenv(LANGUAGE = "pt-br")
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(jsonlite)
library(scales)
```

```{r style, echo=FALSE, warning=FALSE, message=FALSE}
# peguei as cores do site e criei um vetor com nomes fáceis de lembrar
cores_dadosjusbr <- c(
  lilas = "#B361C6",
  cyan = "#2FBB96",
  cinza_azulado = "#3e5363",
  verde = "#96ba2f",
  laranja = "#F2C94C"
)

# cores para índices
cores_indice <- c(
  "Transparência" = cores_dadosjusbr[["cyan"]],
  "Completude" = cores_dadosjusbr[["laranja"]],
  "Facilidade" = cores_dadosjusbr[["lilas"]]
)

theme_set(
  hrbrthemes::theme_ipsum_rc() +
    theme(
      axis.ticks.x = element_line(),
      plot.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]], size = 14),
      plot.subtitle = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      axis.text.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      axis.text.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      axis.title.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      axis.title.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      legend.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      legend.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
      strip.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]])
    )
)

hrbrthemes::update_geom_font_defaults(color = cores_dadosjusbr[["cinza_azulado"]])

theme_adjust_waffle = theme(
  legend.position = "top",
  legend.direction = "vertical",
  legend.justification = "left",
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.spacing = unit(2, "mm"),
  strip.text = element_text(face = "bold")
)

# pega os órgãos da API
orgaos = fromJSON("https://api.dadosjusbr.org/v1/orgaos") %>% as_tibble()

# Função para pegar dados da API
get_data = function(aid, ano){
  message(str_glue("get {aid} {ano}"))
  Sys.sleep(.3)
  fromJSON(
    str_glue("https://api.dadosjusbr.org/v1/dados/{aid}/{ano}")
  )
}

get_data_safe <- safely(get_data)

```

# Ministérios públicos

## Dados

```{r dados-mp}
mps = orgaos %>% filter(entity %in% c("Ministério", "M"), type %in% c("Estadual", "E"))

coletado_mps = mps %>%
  mutate(ano = c(2018:2022, rep(2022, nrow(mps) - 5))) %>% 
  expand(aid, ano) %>% 
  mutate(a1 = map2(aid, ano, get_data_safe))

dados_mps = coletado_mps %>%
  unnest(a1) %>%
  group_by(aid, ano) %>%
  mutate(tipo = c("df", "error")) %>%
  ungroup() %>%
  filter(tipo != "error") %>%
  select(-ano, -tipo) %>%
  unnest(a1)

# https://dadosjusbr.org/orgao/mpam/2022/01
# https://dadosjusbr.org/orgao/mpms/2022/01

indice_mps = dados_mps %>%
  select(aid, mes, ano, Meta) %>%
  unnest(Meta) %>% 
  mutate(
    aid = aid %>% 
      toupper() %>% 
      str_replace("MP", "MP-"),
    manteve_consistencia_no_formato = replace_na(
      manteve_consistencia_no_formato, FALSE
    ),
    dados_estritamente_tabulares = replace_na(
      dados_estritamente_tabulares, FALSE
  )) %>% 
  complete(mes, ano, aid) %>%
  mutate(data = my(str_glue("{mes}-{ano}")))
```

## Índice de Facilidade

- Necessidade de login
- Necessário captcha
- Formato de acesso
- Manteve consistência no formato
- Formato estritamente tabular

### Requer Login

```{r requer-login-mp}
indice_mps %>% 
  select(mes, ano, data, aid, login_nao_necessario) %>%
  mutate(
    ord = case_when(
      login_nao_necessario ~ 1,
      !login_nao_necessario ~ 0,
      TRUE ~ -1
    ),
    login_nao_necessario = case_when(
      login_nao_necessario ~ "Não requer login",
      !login_nao_necessario ~ "Requer login",
      TRUE ~ "Órgão não prestou contas"
    ) %>% ordered(levels = c(
      "Não requer login", "Requer login",
      "Órgão não prestou contas"
    )),
    aid = reorder(aid, ord, sum)
    ) %>% 
  ggplot(aes(x = data, y = aid, fill = login_nao_necessario)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer login" = cores_dadosjusbr[["cyan"]],
    "Requer login" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Necessário captcha

```{r captcha_mp}
indice_mps %>% 
  select(mes, ano, data, aid, captcha_nao_necessario) %>% 
  mutate(
    ord = case_when(
      captcha_nao_necessario ~ 1,
      !captcha_nao_necessario ~ 0,
      TRUE ~ -1
    ),
    captcha_nao_necessario = case_when(
      captcha_nao_necessario ~ "Não requer captcha",
      !captcha_nao_necessario ~ "Requer captcha",
      TRUE ~ "Órgão não prestou contas"
    ) %>% ordered(levels = c(
      "Não requer captcha", "Requer captcha",
      "Órgão não prestou contas"
    )),
    aid = reorder(aid, ord, sum)
    ) %>% 
  ggplot(aes(x = data, y = aid, fill = captcha_nao_necessario)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer captcha" = cores_dadosjusbr[["cyan"]],
    "Requer captcha" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Acesso

```{r acesso-mp}

acesso_labels <- c(
  "Direta",
  "Amigável para raspagem",
  "Raspagem dificultada",
  "Necessita simulação de usuário",
  "Órgão não prestou contas"
)

indice_mps %>% 
  select(mes, ano, data, aid, acesso) %>% 
  mutate(
    ord = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ .5,
      acesso == "RASPAGEM_DIFICULTADA" ~ .25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0,
      TRUE ~ -1
    ),
    acesso = acesso %>% 
      str_replace_all("_", " ") %>% 
      str_to_sentence() %>% 
      str_replace("Amigavel", "Amigável") %>% 
      str_replace("simulacao", "simulação") %>% 
      str_replace("usuario", "de usuário") %>% 
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = acesso_labels),
    aid = reorder(aid, ord)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = acesso)) +
    facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Direta" = cores_dadosjusbr[["verde"]],
    "Amigável para raspagem" = cores_dadosjusbr[["cyan"]],
    "Raspagem dificultada" = cores_dadosjusbr[["lilas"]],
    "Necessita simulação de usuário" = cores_dadosjusbr[["laranja"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Manteve consistência no formato

```{r formato-consistente-mp}
indice_mps %>% 
  select(mes:aid, data, manteve_consistencia_no_formato) %>%
  mutate(
    ord = case_when(
      manteve_consistencia_no_formato ~ 1,
      !manteve_consistencia_no_formato ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    manteve_consistencia_no_formato = case_when(
      manteve_consistencia_no_formato ~ "Manteve consistência no formato",
      !manteve_consistencia_no_formato ~ "Não manteve consistência no formato",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = manteve_consistencia_no_formato)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Manteve consistência no formato" = cores_dadosjusbr[["cyan"]],
    "Não manteve consistência no formato" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Formato estritamente tabular

```{r tabularidade-mp}
indice_mps %>% 
  select(mes:aid, data, dados_estritamente_tabulares) %>%
  mutate(
    ord = case_when(
      dados_estritamente_tabulares ~ 1,
      !dados_estritamente_tabulares ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    dados_estritamente_tabulares = case_when(
      dados_estritamente_tabulares ~ "Dados estritamente tabulares",
      !dados_estritamente_tabulares ~ "Dados não tabulares",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = dados_estritamente_tabulares)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Dados estritamente tabulares" = cores_dadosjusbr[["cyan"]],
    "Dados não tabulares" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

## Índice de Completude

- Nome e matrícula
- Lotação
- Cargo
- Remuneração básica
- Outras receitas
- Detalhamento de despesas

### Nome e matrícula

```{r nome-e-matricula-mps}
indice_mps %>% 
  select(mes:aid, data, tem_matricula) %>% 
  mutate(
    ord = case_when(
      tem_matricula ~ 1,
      !tem_matricula ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_matricula = case_when(
      tem_matricula ~ "Possui nome e matrícula",
      !tem_matricula ~ "Não possui nome e matrícula",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_matricula)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui nome e matrícula" = cores_dadosjusbr[["cyan"]],
    "Não possui nome e matrícula" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Cargo

```{r lotacao-mp}
indice_mps %>% 
  select(mes:aid, data, tem_lotacao) %>% 
  mutate(
    ord = case_when(
      tem_lotacao ~ 1,
      !tem_lotacao ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_lotacao = case_when(
      tem_lotacao ~ "Possui lotação",
      !tem_lotacao ~ "Não possui lotação",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_lotacao)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui lotação" = cores_dadosjusbr[["cyan"]],
    "Não possui lotação" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))

```

### Lotação

```{r cargo-mp}
indice_mps %>% 
  select(mes:aid, data, tem_cargo) %>% 
  mutate(
    ord = case_when(
      tem_cargo ~ 1,
      !tem_cargo ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_cargo = case_when(
      tem_cargo ~ "Possui cargo",
      !tem_cargo ~ "Não possui cargo",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_cargo)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui cargo" = cores_dadosjusbr[["cyan"]],
    "Não possui cargo" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Remuneração básica

```{r remuneracao-basica-mp}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_mps %>%
  select(mes:aid, data, remuneracao_basica) %>%
  mutate(
    ord = case_when(
      remuneracao_basica == "DETALHADO" ~ 1,
      remuneracao_basica == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    remuneracao_basica = remuneracao_basica %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = remuneracao_basica)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Despesas

```{r despesas-mp}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_mps %>% 
  select(mes:aid, data, despesas) %>%
  mutate(
    ord = case_when(
      despesas == "DETALHADO" ~ 1,
      despesas == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    despesas = despesas %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = despesas)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Outras receitas

```{r outras-remuneracoes-mp}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_mps %>% 
  select(mes:aid, data, outras_receitas) %>%
  mutate(
    ord = case_when(
      outras_receitas == "DETALHADO" ~ 1,
      outras_receitas == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    outras_receitas = outras_receitas %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = outras_receitas)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

## Índice de Transparência

```{r indice-long-mp}
criterios <- c("Tem cargo", "Tem lotação", "Tem matrícula", "Remuneração básica", "Outras receitas", "Despesas")

indice_mps_long <- indice_mps %>%
  select(-extensao) %>% 
  mutate(
    # Atribui pontuação para acesso
    acesso = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ 0.5,
      acesso == "RASPAGEM_DIFICULTADA" ~ 0.25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0,
      TRUE ~ NA_real_
    ),
    # Atribui pontuações para classificações de receitas e descontos
    across(c(remuneracao_basica, despesas, outras_receitas),
      ~ case_when(
        . == "DETALHADO" ~ 1,
        . == "SUMARIZADO" ~ 0.5,
        TRUE ~ NA_real_
    ))
  ) %>% 
  pivot_longer(-c(aid, ano, mes, data), names_to = "criterio", values_to = "pontuacao") %>% 
  mutate(
    criterio = case_when(
      criterio == "login_nao_necessario" ~ "Login não necessário",
      criterio == "captcha_nao_necessario" ~ "Captcha não necessário",
      criterio == "acesso" ~ "Acesso",
      criterio == "dados_estritamente_tabulares" ~ "Dados estritamente tabulares",
      criterio == "manteve_consistencia_no_formato" ~ "Manteve consistência no formato",
      criterio == "remuneracao_basica" ~ "Remuneração básica",
      criterio == "outras_receitas" ~ "Outras receitas",
      criterio == "despesas" ~ "Despesas",
      criterio == "tem_matricula" ~ "Tem matrícula",
      criterio == "tem_lotacao" ~ "Tem lotação",
      criterio == "tem_cargo" ~ "Tem cargo",
      TRUE ~ criterio
    ),
    dimensao = if_else(criterio %in% criterios, "Completude", "Facilidade"),
    status = if_else(is.na(pontuacao), "Órgão não prestou contas", "Ok"),
    pontuacao = replace_na(pontuacao, 0)
  )

# Função que faz o cálculo da média harmônica em `indice`
media_harmonica <- function(x,y) if_else(x + y == 0, 0, ((x * y) / (x + y)) * 2)

# `indice_pontuacoes` contém os índices de Completude, Facilidade e Transparência
indice_mps_pontuacoes <- indice_mps_long %>%
  group_by(mes, ano, aid, dimensao) %>%
  summarise(indice = mean(pontuacao), .groups = "drop") %>%
  pivot_wider(names_from = dimensao, values_from = indice) %>% 
  mutate(Transparência = media_harmonica(Completude, Facilidade))
```

```{r indice-media-geral-mp}
# `indice_media_geral`: média aritmética simples dos índices de todo o período
indice_mps_media_geral <- indice_mps_pontuacoes %>%
  group_by(aid) %>%
  summarise(across(c(Completude, Facilidade, Transparência), mean, .groups = "drop"))
```

```{r plot-indice-mp}
# `cut_orgao` é o órgão que manterá a caixa diálogo no plot
cut_orgao_mps <- indice_mps_media_geral %>%
  pivot_longer(-aid, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(aid = reorder(aid, pontuacao, sum)) %>%
  filter(dimensao == "Transparência", aid == "MP-MG") %>%
  mutate(
    center = 1.16,
    lbl = str_glue(" índice de\nTransparência é uma\nmédia harmônica\ndas pontuações\nobtidas nas dimensões\nCompletude e Facilidade")
  )

plot_mp <- indice_mps_media_geral %>%
  pivot_longer(-aid, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(aid = reorder(aid, pontuacao, sum)) %>% 
  ggplot(aes(
    y = aid,
    x = pontuacao
  )) +
  geom_line(color = cores_dadosjusbr[["cinza_azulado"]]) +
  geom_point(
    data = . %>% filter(dimensao != "Transparência"),
    aes(fill = dimensao, size = dimensao),
    shape = 21,
    size = 3.5
  ) +
  geom_point(
    data = . %>%
    filter(dimensao == "Transparência") %>%
    mutate(indice = "Índice de Transparência"),
    size = .25
  ) +
  geom_point(
    data = . %>%
      filter(dimensao == "Transparência") %>%
      mutate(indice = "Índice de Transparência"),
    aes(color = indice),
    size = 6,
    alpha = .7
  ) +
  scale_x_continuous(
    limits = c(-.01, 1.3),
    breaks = c(0, .25, .5, .75, 1),
    minor_breaks = c(.25, .75),
    expand = c(.001, 0)
  ) +
  scale_fill_manual(values = c(
    "Completude" = cores_dadosjusbr[["laranja"]],
    "Facilidade" = cores_dadosjusbr[["lilas"]]
  )) +
  scale_color_manual(values = cores_dadosjusbr[["cyan"]]) +
  geom_curve(
    data = cut_orgao_mps,
    aes(x = center, xend = pontuacao, y = aid, yend = aid),
    color = cores_dadosjusbr[["cinza_azulado"]],
    size = .3, arrow = arrow(length = unit(2, "mm")), curvature = -0.2
  ) +
  geom_label(
    data = cut_orgao_mps, size = 3, label.r = unit(.3, "lines"), lineheight = 1.1,
    aes(x = center, y = aid, label = lbl), fontface = "bold"
  ) +
  labs(
    title = "Índice de Transparência DadosJusBr (2018-2021)\nMinistérios Públicos",
    x = "Pontuação", y = NULL, fill = "Dimensões", color = ""
  ) +
  theme(
    plot.title = element_text(size = 13),
    axis.title.x = element_text(vjust = -.5, hjust = .8),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(vjust = -.2),
    legend.position = "top",
    legend.justification = "left",
    legend.background = element_rect(
      fill = alpha(cores_dadosjusbr[["cinza_azulado"]], .1),
      color = "transparent"
    )
  ) +
  guides(
    fill = guide_legend(
      order = 2,
      label.theme = element_text(size = 10),
      title.theme = element_text(size = 10)
    ),
    color = guide_legend(order = 1, label.theme = element_text(size = 12))
  )

pngfile <- fs::path(knitr::fig_path(),  "indice-transparencia-mps.png")
ragg::agg_png(pngfile, width = 850, height = 850, res = 100)
plot_mp
invisible(dev.off())
knitr::include_graphics(pngfile)
```

# Tribunais de Justiça

## Dados 

```{r dados-tj}
tjs = orgaos %>% filter(str_detect(aid, "^tj"))

coletado_tjs = tjs %>%
  mutate(ano = c(2018:2022, rep(2022, nrow(tjs) - 5))) %>% 
  expand(aid, ano) %>% 
  mutate(a1 = map2(aid, ano, get_data_safe))

dados_tjs = coletado_tjs %>%
  unnest(a1) %>%
  group_by(aid, ano) %>%
  mutate(tipo = c("df", "error")) %>%
  ungroup() %>%
  filter(tipo != "error") %>%
  select(-ano, -tipo) %>%
  unnest(a1)

indice_tjs = dados_tjs %>%
  select(aid, mes, ano, Meta) %>%
  unnest(Meta) %>% 
  mutate(
    aid = aid %>% 
      toupper() %>% 
      str_replace("TJ", "TJ-"),
    manteve_consistencia_no_formato = replace_na(
      manteve_consistencia_no_formato, FALSE
    ),
    dados_estritamente_tabulares = replace_na(
      dados_estritamente_tabulares, FALSE
  )) %>% 
  # completa dados com meses onde orgaos nao prestaram contas, criterios 
  # ficarão missing values (exceto na dimensão de facilidade para TJs, para
  # refletir a usabilidade da plataforma do CNJ)
  complete(mes, ano, aid) %>%
  mutate(
    data = my(str_glue("{mes}-{ano}")),
    tem_matricula = if_else(is.na(acesso), NA, FALSE),
    tem_lotacao = if_else(is.na(acesso), NA, FALSE),
    tem_cargo = if_else(is.na(acesso), NA, FALSE)
  )
```

## Índice de Facilidade

- Necessidade de login
- Necessário captcha
- Formato de acesso
- Manteve consistência no formato
- Formato estritamente tabular

### Requer Login

```{r requer-login-tj}
indice_tjs %>% 
  select(mes, ano, data, aid, login_nao_necessario) %>%
  mutate(
    ord = case_when(
      login_nao_necessario ~ 1,
      !login_nao_necessario ~ 0,
      TRUE ~ -1
    ),
    login_nao_necessario = case_when(
      login_nao_necessario ~ "Não requer login",
      !login_nao_necessario ~ "Requer login",
      TRUE ~ "Órgão não prestou contas"
    ) %>% ordered(levels = c(
      "Não requer login", "Requer login",
      "Órgão não prestou contas"
    )),
    aid = reorder(aid, ord, sum)
    ) %>% 
  ggplot(aes(x = data, y = aid, fill = login_nao_necessario)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer login" = cores_dadosjusbr[["cyan"]],
    "Requer login" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Necessário captcha

```{r captcha-tj}
indice_tjs %>% 
  select(mes, ano, data, aid, captcha_nao_necessario) %>% 
  mutate(
    ord = case_when(
      captcha_nao_necessario ~ 1,
      !captcha_nao_necessario ~ 0,
      TRUE ~ -1
    ),
    captcha_nao_necessario = case_when(
      captcha_nao_necessario ~ "Não requer captcha",
      !captcha_nao_necessario ~ "Requer captcha",
      TRUE ~ "Órgão não prestou contas"
    ) %>% ordered(levels = c(
      "Não requer captcha", "Requer captcha",
      "Órgão não prestou contas"
    )),
    aid = reorder(aid, ord, sum)
    ) %>% 
  ggplot(aes(x = data, y = aid, fill = captcha_nao_necessario)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer captcha" = cores_dadosjusbr[["cyan"]],
    "Requer captcha" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Acesso

```{r acesso-tj}

acesso_labels <- c(
  "Direta",
  "Amigável para raspagem",
  "Raspagem dificultada",
  "Necessita simulação de usuário",
  "Órgão não prestou contas"
)

indice_tjs %>% 
  select(mes, ano, data, aid, acesso) %>% 
  mutate(
    ord = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ .5,
      acesso == "RASPAGEM_DIFICULTADA" ~ .25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0,
      TRUE ~ -1
    ),
    acesso = acesso %>% 
      str_replace_all("_", " ") %>% 
      str_to_sentence() %>% 
      str_replace("Amigavel", "Amigável") %>% 
      str_replace("simulacao", "simulação") %>% 
      str_replace("usuario", "de usuário") %>% 
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = acesso_labels),
    aid = reorder(aid, ord)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = acesso)) +
    facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Direta" = cores_dadosjusbr[["verde"]],
    "Amigável para raspagem" = cores_dadosjusbr[["cyan"]],
    "Raspagem dificultada" = cores_dadosjusbr[["lilas"]],
    "Necessita simulação de usuário" = cores_dadosjusbr[["laranja"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Manteve consistência no formato

```{r formato-consistente-tj}
indice_tjs %>% 
  select(mes:aid, data, manteve_consistencia_no_formato) %>%
  mutate(
    ord = case_when(
      manteve_consistencia_no_formato ~ 1,
      !manteve_consistencia_no_formato ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    manteve_consistencia_no_formato = case_when(
      manteve_consistencia_no_formato ~ "Manteve consistência no formato",
      !manteve_consistencia_no_formato ~ "Não manteve consistência no formato",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = manteve_consistencia_no_formato)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Manteve consistência no formato" = cores_dadosjusbr[["cyan"]],
    "Não manteve consistência no formato" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Formato estritamente tabular

```{r tabularidade-tj}
indice_tjs %>% 
  select(mes:aid, data, dados_estritamente_tabulares) %>%
  mutate(
    ord = case_when(
      dados_estritamente_tabulares ~ 1,
      !dados_estritamente_tabulares ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    dados_estritamente_tabulares = case_when(
      dados_estritamente_tabulares ~ "Dados estritamente tabulares",
      !dados_estritamente_tabulares ~ "Dados não tabulares",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = dados_estritamente_tabulares)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Dados estritamente tabulares" = cores_dadosjusbr[["cyan"]],
    "Dados não tabulares" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

## Índice de Completude

- Nome e matrícula
- Lotação
- Cargo
- Remuneração básica
- Outras receitas
- Detalhamento de despesas

### Nome e matrícula

```{r nome-e-matricula-tj}
indice_tjs %>% 
  select(mes:aid, data, tem_matricula) %>% 
  mutate(
    ord = case_when(
      tem_matricula ~ 1,
      !tem_matricula ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_matricula = case_when(
      tem_matricula ~ "Possui nome e matrícula",
      !tem_matricula ~ "Não possui nome e matrícula",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_matricula)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui nome e matrícula" = cores_dadosjusbr[["cyan"]],
    "Não possui nome e matrícula" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))

```

### Lotação

```{r lotacao-tj}
indice_tjs %>% 
  select(mes:aid, data, tem_lotacao) %>% 
  mutate(
    ord = case_when(
      tem_lotacao ~ 1,
      !tem_lotacao ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_lotacao = case_when(
      tem_lotacao ~ "Possui lotação",
      !tem_lotacao ~ "Não possui lotação",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_lotacao)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui lotação" = cores_dadosjusbr[["cyan"]],
    "Não possui lotação" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Cargo

```{r cargo-tj}
indice_tjs %>% 
  select(mes:aid, data, tem_cargo) %>% 
  mutate(
    ord = case_when(
      tem_cargo ~ 1,
      !tem_cargo ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    tem_cargo = case_when(
      tem_cargo ~ "Possui cargo",
      !tem_cargo ~ "Não possui cargo",
      TRUE ~ "Órgão não prestou contas"
    )
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = tem_cargo)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui cargo" = cores_dadosjusbr[["cyan"]],
    "Não possui cargo" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 2))
```

### Remuneração básica

```{r remuneracao-basica-tj}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_tjs %>%
  select(mes:aid, data, remuneracao_basica) %>%
  mutate(
    ord = case_when(
      remuneracao_basica == "DETALHADO" ~ 1,
      remuneracao_basica == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    remuneracao_basica = remuneracao_basica %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = remuneracao_basica)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Despesas

```{r despesas-tj}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_tjs %>% 
  select(mes:aid, data, despesas) %>%
  mutate(
    ord = case_when(
      despesas == "DETALHADO" ~ 1,
      despesas == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    despesas = despesas %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = despesas)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

### Outras receitas

```{r outras-remuneracoes-tj}
remuneracao_labels <- c("Detalhado", "Sumarizado", "Órgão não prestou contas")

indice_tjs %>% 
  select(mes:aid, data, outras_receitas) %>%
  mutate(
    ord = case_when(
      outras_receitas == "DETALHADO" ~ 1,
      outras_receitas == "SUMARIZADO" ~ 0,
      TRUE ~ -1
    ),
    aid = reorder(aid, ord),
    outras_receitas = outras_receitas %>% 
      str_to_sentence() %>%
      replace_na("Órgão não prestou contas") %>% 
      ordered(levels = remuneracao_labels)
  ) %>% 
  ggplot(aes(x = data, y = aid, fill = outras_receitas)) +
  facet_wrap(~ ano, scales = "free_x", nrow = 1) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Detalhado" = cores_dadosjusbr[["cyan"]],
    "Sumarizado" = cores_dadosjusbr[["lilas"]],
    "Órgão não prestou contas" = cores_dadosjusbr[["cinza_azulado"]]
  )) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  theme_adjust_waffle +
  labs(
    x = "Cada célula representa 1 mês",
    y = NULL,
    title = NULL,
    fill = NULL
  ) +
  guides(fill = guide_legend(ncol = 3))
```

## Índice de Transparência

```{r indice-long-tj}

criterios <- c("Tem cargo", "Tem lotação", "Tem matrícula", "Remuneração básica", "Outras receitas", "Despesas")

indice_tjs_long <- indice_tjs %>% 
  select(-extensao) %>% 
  mutate(
    # Atribui pontuação para acesso
    acesso = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ 0.5,
      acesso == "RASPAGEM_DIFICULTADA" ~ 0.25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0,
      TRUE ~ NA_real_
    ),
    # Atribui pontuações para classificações de receitas e descontos
    across(c(remuneracao_basica, despesas, outras_receitas),
      ~ case_when(
        . == "DETALHADO" ~ 1,
        . == "SUMARIZADO" ~ 0.5,
        TRUE ~ NA_real_
    ))
  ) %>% 
  pivot_longer(-c(aid, ano, mes, data), names_to = "criterio", values_to = "pontuacao") %>%
  mutate(
    criterio = case_when(
      criterio == "login_nao_necessario" ~ "Login não necessário",
      criterio == "captcha_nao_necessario" ~ "Captcha não necessário",
      criterio == "acesso" ~ "Acesso",
      criterio == "dados_estritamente_tabulares" ~ "Dados estritamente tabulares",
      criterio == "manteve_consistencia_no_formato" ~ "Manteve consistência no formato",
      criterio == "remuneracao_basica" ~ "Remuneração básica",
      criterio == "outras_receitas" ~ "Outras receitas",
      criterio == "despesas" ~ "Despesas",
      criterio == "tem_matricula" ~ "Tem matrícula",
      criterio == "tem_lotacao" ~ "Tem lotação",
      criterio == "tem_cargo" ~ "Tem cargo",
      TRUE ~ criterio
    ),
    dimensao = if_else(criterio %in% criterios, "Completude", "Facilidade"),
    status = if_else(is.na(pontuacao), "Órgão não prestou contas", "Ok"),
    pontuacao = replace_na(pontuacao, 0),
    # correção para critérios de facilidade nos TJ devem refletir a plataforma do CNJ
    pontuacao = case_when(
      criterio == "Login não necessário" & status != "Ok" ~ 1,
      criterio == "Captcha não necessário" & status != "Ok" ~ 1,
      criterio == "Acesso" & status != "Ok" ~ 0,
        criterio == "Dados estritamente tabulares" & status != "Ok" ~ 1,
      criterio == "Manteve consistência no formato" & status != "Ok" ~ 1,
      TRUE ~ pontuacao
    )
  )

# Função que faz o cálculo da média harmônica em `indice`
media_harmonica <- function(x,y) if_else(x + y == 0, 0, ((x * y) / (x + y)) * 2)

# `indice_pontuacoes` contém os índices de Completude, Facilidade e Transparência
indice_tjs_pontuacoes <- indice_tjs_long %>%
  group_by(mes, ano, aid, dimensao) %>%
  summarise(indice = mean(pontuacao), .groups = "drop") %>%
  pivot_wider(names_from = dimensao, values_from = indice) %>% 
  mutate(Transparência = media_harmonica(Completude, Facilidade))
```

```{r indice-media-geral}
# `indice_media_geral`: média aritmética simples dos índices de todo o período
indice_tjs_media_geral <- indice_tjs_pontuacoes %>%
  group_by(aid) %>%
  summarise(across(c(Completude, Facilidade, Transparência), mean, .groups = "drop"))
```

```{r}
# `cut_orgao` é o órgão que manterá a caixa diálogo no plot
cut_orgao_tjs <- indice_tjs_media_geral %>%
  pivot_longer(-aid, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(aid = reorder(aid, pontuacao, sum)) %>%
  filter(dimensao == "Transparência", aid == "TJ-MS") %>%
  mutate(
    center = 1.1,
    lbl = str_glue(" índice de\nTransparência é uma\nmédia harmônica\ndas pontuações\nobtidas nas dimensões\nCompletude e Facilidade")
  )

plot_tj <- indice_tjs_media_geral %>%
  pivot_longer(-aid, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(aid = reorder(aid, pontuacao, sum)) %>% 
  ggplot(aes(
    y = aid,
    x = pontuacao
  )) +
  geom_line(color = cores_dadosjusbr[["cinza_azulado"]]) +
  geom_point(
    data = . %>% filter(dimensao != "Transparência"),
    aes(fill = dimensao, size = dimensao),
    shape = 21,
    size = 3.5
  ) +
  geom_point(
    data = . %>%
    filter(dimensao == "Transparência") %>%
    mutate(indice = "Índice de Transparência"),
    size = .25
  ) +
  geom_point(
    data = . %>%
      filter(dimensao == "Transparência") %>%
      mutate(indice = "Índice de Transparência"),
    aes(color = indice),
    size = 6,
    alpha = .7
  ) +
  scale_x_continuous(
    limits = c(-.01, 1.3),
    breaks = c(0, .25, .5, .75, 1),
    minor_breaks = c(.25, .75),
    expand = c(.001, 0)
  ) +
  scale_fill_manual(values = c(
    "Completude" = cores_dadosjusbr[["laranja"]],
    "Facilidade" = cores_dadosjusbr[["lilas"]]
  )) +
  scale_color_manual(values = cores_dadosjusbr[["cyan"]]) +
  geom_curve(
    data = cut_orgao_tjs,
    aes(x = center, xend = pontuacao, y = aid, yend = aid),
    color = cores_dadosjusbr[["cinza_azulado"]],
    size = .3, arrow = arrow(length = unit(2, "mm")), curvature = -0.2
  ) +
  geom_label(
    data = cut_orgao_tjs, size = 3, label.r = unit(.3, "lines"), lineheight = 1.1,
    aes(x = center, y = aid, label = lbl), fontface = "bold"
  ) +
  labs(
    title = "Índice de Transparência DadosJusBr (2018-2021)\nMinistérios Públicos",
    x = "Pontuação", y = NULL, fill = "Dimensões", color = ""
  ) +
  theme(
    plot.title = element_text(size = 13),
    axis.title.x = element_text(vjust = -.5, hjust = .8),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(vjust = -.2),
    legend.position = "top",
    legend.justification = "left",
    legend.background = element_rect(
      fill = alpha(cores_dadosjusbr[["cinza_azulado"]], .1),
      color = "transparent"
    )
  ) +
  guides(
    fill = guide_legend(
      order = 2,
      label.theme = element_text(size = 10),
      title.theme = element_text(size = 10)
    ),
    color = guide_legend(order = 1, label.theme = element_text(size = 12))
  )

pngfile <- fs::path(knitr::fig_path(),  "indice-transparencia-tjs.png")
ragg::agg_png(pngfile, width = 800, height = 1000, res = 100)
plot_tj
invisible(dev.off())
knitr::include_graphics(pngfile)
```