---
title: "Gráficos para o relatório"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      collapse = TRUE,
                      comment = "#>",
                      fig.height = 8,
                      fig.width = 9)

set.seed(1014)
options(digits = 2, scipen = 999, OutDec = ",")
Sys.setenv(LANGUAGE = "pt-br")

library(tidyverse)
library(lubridate)
library(here)

# peguei as cores do site e criei um vetor com nomes fáceis de lembrar
cores_dadosjusbr <- c(
  lilas = "#B361C6",
  cyan = "#2FBB96",
  cinza_azulado = "#3e5363",
  verde = "#96ba2f",
  laranja = "#F2C94C"
)

cores_natureza <- c(
  "Desconto" = cores_dadosjusbr[["lilas"]],
  "Recebimento" = cores_dadosjusbr[["cyan"]]
)

cores_indice <- c(
  "Transparência" = cores_dadosjusbr[["cyan"]],
  "Completude" = cores_dadosjusbr[["laranja"]],
  "Facilidade" = cores_dadosjusbr[["lilas"]]
)

theme_set(
  hrbrthemes::theme_ipsum_rc() +
  theme(
    axis.ticks.x = element_line(),
    plot.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]], size = 14),
    plot.subtitle = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    strip.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]])
  )
)
hrbrthemes::update_geom_font_defaults(color = cores_dadosjusbr[["cinza_azulado"]])
```

## Dataset

```{r echo = TRUE}
indice_long <- readRDS(here("data/load/indice-long.rds"))
```

`indice_long` é preparado [neste script]("src/indice-long.rds")

```{r echo = TRUE}
indice_long
```

# Calculando índices

Completude e Facilidade é a média aritmética simples de seus respectivos critérios:

```{r echo = TRUE}
indice <- indice_long %>%
  group_by(mes, ano, orgao, dimensao) %>%
  summarise(indice = mean(pontuacao), .groups = "drop") %>%
  pivot_wider(names_from = dimensao, values_from = indice)
```

O Índice de Transparência é a média harmônica dos índices de Completude e Facilidade:

```{r echo = TRUE}
media_harmonica <- function(x,y) if_else(x + y == 0, 0, ((x * y) / (x + y)) * 2)

```

```{r echo = TRUE}
indice <- indice %>%
  mutate(Transparência = media_harmonica(Completude, Facilidade))

# preview
DT::datatable(indice)
```
</br></br>

# Média geral

```{r}
indice_media_geral <- indice %>%
  group_by(orgao) %>%
  summarise(across(c(Completude, Facilidade, Transparência), mean, .groups = "drop"))
```

```{r echo = FALSE}
cut_orgao <- indice_media_geral %>%
  pivot_longer(-orgao, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(orgao = reorder(orgao, pontuacao, sum)) %>%
  filter(dimensao == "Transparência", orgao == "MP-RO") %>%
  mutate(
    center = .5,
    lbl = str_glue(" índice de\nTransparência é uma\nmédia harmônica\ndas pontuações\nobtidas nas dimensões\nCompletude e Facilidade")
  )

indice_media_geral %>%
  pivot_longer(-orgao, names_to = "dimensao", values_to = "pontuacao") %>%
  mutate(orgao = reorder(orgao, pontuacao, sum)) %>%
  ggplot(aes(
    y = orgao,
    x = pontuacao
  )) +
  geom_line(color = cores_dadosjusbr[["cinza_azulado"]]) +
  geom_point(
    data = . %>% filter(dimensao != "Transparência"),
    aes(fill = dimensao, size = dimensao),
    shape = 21,
    size = 3.5
  ) +
  geom_point(
    data = . %>%
    filter(dimensao == "Transparência") %>%
    mutate(indice = "Índice de Transparência"),
    size = .25
  ) +
  geom_point(
    data = . %>%
      filter(dimensao == "Transparência") %>%
      mutate(indice = "Índice de Transparência"),
    aes(color = indice),
    size = 6,
    alpha = .7
  ) +
  scale_x_continuous(
    limits = c(-.01, 1.1),
    breaks = c(0, .25, .5, .75, 1),
    minor_breaks = c(.25, .75),
    expand = c(.001, 0)
  ) +
  scale_fill_manual(values = c(
    "Completude" = cores_dadosjusbr[["laranja"]],
    "Facilidade" = cores_dadosjusbr[["lilas"]]
  )) +
  scale_color_manual(values = cores_dadosjusbr[["cyan"]]) +
  geom_curve(
    data = cut_orgao,
    aes(x = center, xend = pontuacao, y = orgao, yend = orgao),
    color = cores_dadosjusbr[["cinza_azulado"]],
    size = .3, arrow = arrow(length = unit(2, "mm")), curvature = -0.2
  ) +
  geom_label(
    data = cut_orgao, size = 3, label.r = unit(.3, "lines"), lineheight = 1.1,
    aes(x = center, y = orgao, label = lbl), fontface = "bold"
  ) +
  labs(
    title = "Índice de Transparência DadosJusBr (2018-2021)\nMinistérios Públicos",
    x = "Pontuação", y = NULL, fill = "Dimensões", color = ""
  ) +
  theme(
    plot.title = element_text(size = 13),
    axis.title.x = element_text(vjust = -.5),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(vjust = -.2),
    legend.position = "top",
    legend.justification = "left",
    legend.background = element_rect(
      fill = alpha(cores_dadosjusbr[["cinza_azulado"]], .1),
      color = "transparent"
    )
  ) +
  guides(
    fill = guide_legend(
      order = 2,
      label.theme = element_text(size = 10),
      title.theme = element_text(size = 10)
    ),
    color = guide_legend(order = 1, label.theme = element_text(size = 12))
  )
```


## Demonstração do cálculo da média geral: estado do Amazonas

```{r fig.height = 12, fig.width = 10, echo = FALSE}
library(lubridate)

mpam <- indice %>% filter(orgao == "MP-AM")

p1 <- mpam %>%
  pivot_longer(-c(mes, ano, orgao), values_to = "pontuacao", names_to = "dimensao") %>%
  mutate(
    data = ym(str_glue("{ano}-{mes}")),
    pontuacao = as.ordered(pontuacao)
  ) %>%
  ggplot(aes(x = data, y = orgao, fill = pontuacao)) +
  geom_tile(color = "black", show.legend = F) +
  geom_text(
    data = . %>% filter(mes == 1 & ano %in% c(2019, 2021)),
    aes(label = pontuacao, x = data), size = 9, fontface = "bold"
  ) +
  facet_wrap(dimensao ~ ., ncol = 1, scales = "free") +
  scale_x_date(expand = c(0, 0)) +
  scale_fill_manual(values = c(
    "0" = "gray50",
    "0,6" = cores_indice[["Facilidade"]],
    "0,75" = cores_indice[["Transparência"]],
    "1" = cores_indice[["Completude"]]
  )) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  labs(
    title = "Médias mensais",
    subtitle = str_glue("Cada célula é um mês, ", "as pontuações são constantes."),
    y = NULL, x = NULL
  )

segment <- mpam %>%
  group_by(ano) %>%
  summarise(across(where(is.double), mean), .groups = "drop") %>%
  transmute(
    x = ano, xend = ano, y = Facilidade, yend = Completude
  )

p2 <- mpam %>%
  group_by(ano) %>%
  summarise(across(where(is.double), mean), .groups = "drop") %>%
  pivot_longer(-ano, values_to = "pontuacao", names_to = "dimensao") %>%
  ggplot(aes(x = ano, y = pontuacao)) +
  geom_segment(data = segment, aes(x = x, xend = xend, y = y, yend = yend), size = .5) +
  geom_point(show.legend = FALSE, aes(fill = dimensao, size = dimensao), shape = 21) +
  geom_text(aes(label = pontuacao), size = 5, nudge_x = .15) +
  scale_fill_manual(values = cores_indice) +
  scale_y_continuous(limits = c(-.1, 1.1)) +
  scale_size_manual(values = c("Transparência" = 8, "Completude" = 4, "Facilidade" = 4)) +
  labs(y = "Pontuação média anual", title = "Médias anuais", x = NULL)

segment <- tibble(
  x = .5, xend = .3,
  y = "Média geral", yend = "Média geral"
)

p3 <- mpam %>%
  group_by(orgao) %>%
  summarise(across(where(is.double), mean), .groups = "drop") %>%
  pivot_longer(-orgao, values_to = "pontuacao", names_to = "dimensao") %>%
  ggplot(aes(y = "Média geral", x = pontuacao)) +
  geom_segment(data = segment, aes(x = x, xend = xend, y = y, yend = yend), size = .5, color = "black") +
  geom_point(aes(size = dimensao, fill = dimensao), shape = 21, show.legend = FALSE) +
  geom_text(aes(label = round(pontuacao, 2)), size = 6, fontface = "bold", nudge_y = .1) +
  scale_size_manual(values = c("Transparência" = 8, "Completude" = 4, "Facilidade" = 4)) +
  scale_fill_manual(values = cores_indice) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(title = "Média geral", y = NULL, x = "Pontuação média geral")

library(patchwork)
p1 / p2 / p3
```

# Pontuação média monitoramento do índice de transparência mês a mês

```{r fig.height=7, fig.width=12}
indice %>%
  mutate(data = as.Date(str_glue("{ano}-{mes}-01"))) %>%
  ggplot(aes(x = data, y = reorder(orgao, Transparência), fill = Transparência)) +
  geom_tile(color = "gray10") +
  scale_x_date(expand = c(0, 0)) +
  scale_fill_gradientn(
    limits = c(0, 1),
    breaks = c(0, .25, .5, .75, 1),
    labels = c("0", "0,25", "0,5", "0,75", "1"),
    colours = c(
      "black",
      "gray15",
      cores_dadosjusbr[["cinza_azulado"]],
      cores_indice[["Transparência"]]
    )
  ) +
  facet_grid(~ano, scales = "free") +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.justification = "left",
    legend.spacing.x = unit(1, 'mm'),
    legend.key.width= unit(1, 'cm'),
    legend.key.height = unit(.35, "cm"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold", size = 10)
  )  +
  guides(fill = guide_legend(
    title.position="top",
    title.hjust = 0,
    label.vjust = -1,
    label.position = "top"
  )) +
  labs(
    title = NULL,
    subtitle = NULL,
    fill = NULL,
    x = NULL,
    y = NULL,
    caption = "Cada célula representa um mês"
  )
```

