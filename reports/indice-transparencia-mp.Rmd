---
title: "Índice de Transparência nos Ministérios Públicos"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(tidy = FALSE, 
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 10,
                      fig.width = 8)
set.seed(1014)
options(digits = 2, scipen = 999, OutDec = ",")


Sys.setenv(LANGUAGE = "pt-br")

```

```{r echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(hrbrthemes)
library(ggbeeswarm)
library(lubridate)
library(here)
library(waffle)

# peguei as cores do site e criei um vetor com nomes fáceis de lembrar
cores_dadosjusbr <- c(
  lilas = "#B361C6",
  cyan = "#2FBB96",
  cinza_azulado = "#3e5363",
  verde = "#96ba2f",
  laranja = "#F2C94C"
)

cores_natureza <- c(
  "Desconto" = cores_dadosjusbr[["lilas"]],
  "Recebimento" = cores_dadosjusbr[["cyan"]]
)

cores_indice <- c(
  "Transparência" = cores_dadosjusbr[["cyan"]],
  "Completude" = cores_dadosjusbr[["laranja"]],
  "Facilidade" = cores_dadosjusbr[["lilas"]]
)

theme_set(
  theme_ipsum_rc() +
  theme(
    axis.ticks.x = element_line(),
    plot.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]], size = 14),
    plot.subtitle = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    strip.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]])
  )
)

update_geom_font_defaults(color = cores_dadosjusbr[["cinza_azulado"]])
```

```{r}
estrutura <- function() {
  full <- cols(
    orgao = col_character(),
    receita_base = col_character(),
    despesas = col_character(),
    outras_receitas = col_character(),
    acesso = col_character(),
    ano = col_integer(),
    mes = col_integer(),
    acesso_i = col_integer(),
    indice_completude = col_double(), 
    indice_facilidade = col_double(),
    indice_transparencia = col_double(),
    tem_lotacao = col_logical(),
    tem_cargo = col_logical(),
    tem_matricula = col_logical(),
    nao_requer_login = col_logical(),
    nao_requer_captcha = col_logical(),
    formato_consistente = col_logical(),
    estritamente_tabular = col_logical()
  )
  media <- cols(
    orgao = col_character(),
    media_indice_completude = col_double(),
    media_indice_facilidade = col_double(),
    media_indice_transparencia = col_double()
  )
  
  return(list(full = full, media = media))
}

col_defs <- estrutura()

indice <- "data/load" %>% 
  here() %>%
  list.files(pattern = "^indice_transparencia.*_2022_02_11",
             full.names = TRUE) %>% 
  set_names(c("full", "media")) %>%
  map2(col_defs, ~ read_csv(.x, col_types = .y))

# vamos recalcular os índices
indice$full <- indice$full %>% 
  # select(-indice_completude,
  #        -indice_facilidade,
  #        -indice_transparencia) %>% 
  filter(str_detect(orgao, "^mp")) %>% 
  mutate(orgao = toupper(orgao) %>% str_replace("^MP", "MP-"))
```

## Índice de Facilidade

### Necessidade de login

Necessidade de Login: a necessidade de fornecimento de informações pessoais e autenticação para acesso dos dados. Requrer é o pior caso.

Valores:

- $1$: não requer login
- $0$: requer login

```{r}
indice$full %>% 
  select(orgao, ano, mes, nao_requer_login, indice_facilidade)
```


### Acesso

Se é possível acessar os dados programaticamente através de URLs que seguem boas práticas, se é necessário raspar os dados de maneira fácil (pois páginas e URLs têm boas práticas de estrutura), se é necessário raspagem complexa ou se é necessário simular um usuário usando um navegador (pior caso).

Valores:

- $1,00$: o acesso é feito de forma **DIRETA**, através de URLs que seguem boas práticas
- $0,50$: o acesso é **AMIGAVEL PARA RASPAGEM**
- $0,25$: o acesso **NÃO É AMIGAVEL PARA RASPAGEM**
- $0,00$: é **NECESSÁRIO SIMULAÇÃO DE USUÁRIO** para acesso

```{r}
mps_nao_coletados <- c("RJ", "RS", "PA", "SC", "ES", "MA", "AC", "RR") %>% 
  paste0("MP-", .)

acesso <- indice$full %>% 
  select(orgao, ano, mes, acesso, indice_facilidade) %>%
  mutate(
    data = dmy(str_glue("01-{mes}-{ano}")),
    mes = month.abb[month(data)],
    orgao = factor(
      orgao, levels = unique(c(unique(indice$full$orgao), mps_nao_coletados))
    ),
    pontuacao_acesso = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ 0.5,
      acesso == "RASPAGEM_DIFICULTADA" ~ 0.25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0
      ),
    acesso = acesso %>% 
      str_to_sentence() %>% 
      str_replace_all("Amigavel", "Amigável") %>% 
      str_replace_all("simulacao", "simulação") %>% 
      str_replace_all("usuario", "de usuário") %>% 
      str_replace_all("_", " ") %>% 
      fct_reorder(pontuacao_acesso)
  ) 

```

```{r fig.height=10, fig.width=9}
acesso %>% 
  complete() %>% 
  ggplot(aes(
    y = reorder(orgao, pontuacao_acesso, sum, na.rm = TRUE),
    x = data, 
    fill = acesso
  )) +
  geom_tile(color = "gray90") +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x") +
  scale_fill_manual(values = c(
    "Direta" = cores_dadosjusbr[["cyan"]],
    "Amigável para raspagem" = cores_dadosjusbr[["laranja"]],
    "Raspagem dificultada" = cores_dadosjusbr[["lilas"]],
    "Necessita simulação de usuário" = cores_dadosjusbr[["cinza_azulado"]]
  ), na.value = "red") +
  scale_y_discrete()+#drop=FALSE) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    fill = "Forma de acesso",
    title = "Classificação da forma de acesso para dados de remuneração\nnos Ministérios Públicos",
    subtitle = "Acessibilidade dos dados verificadas mês a mês",
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(legend.position = "top",
        legend.justification = "left") +
  guides(fill = guide_legend(ncol = 1, title.position = "top"))
```

```{r}
acesso %>% 
  select(-data) %>% 
  group_by(orgao, ano) %>% 
  summarise(across(where(is.double), mean, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(-c(orgao, ano), names_to = "indice", values_to = "valor") %>% 
  mutate(ord = if_else(indice == "indice_facilidade", valor, NA_real_)) %>% 
  fill(ord, .direction = "down") %>% 
  mutate(
    indice = if_else(indice == "indice_facilidade",
                     "Índice de Facilidade", 
                     "Pontuação Acesso")
  ) %>% 
  ggplot(aes(
    x = tidytext::reorder_within(orgao, ord, ano, sum),
    y = valor,
    color = indice,
    group = orgao
  )) +
  coord_flip() +
  scale_color_manual(values = c(
    "Índice de Facilidade" = cores_dadosjusbr[["lilas"]],
    "Pontuação Acesso" = cores_dadosjusbr[["cinza_azulado"]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_size_manual(values = c(3, 1),
                    guide = guide_legend(reverse = TRUE)) +
  facet_wrap(~ ano, scales = "free") +
  geom_line(color = "gray80", size = 1.5) +
  geom_point(aes(size = indice)) +
  # geom_text(
  #   data = . %>% filter(indice == "Índice de Facilidade"),
  #   aes(label = orgao),
  #   color = "black",
  #   hjust = -0.3,
  #   size = 3
  # ) +
  scale_y_continuous(limits = c(0, 1)) +
  tidytext::scale_x_reordered() +
  labs(x = "Órgão",
       y = "Pontuação",
       color = NULL,
       size = NULL,
       title = "Índice de Facilidade vs Pontuação de Acesso (2018-2021)",
       subtitle = "Média anual por órgão",
       caption = "Classificações quanto ao acesso: "
       ) +
  theme(
    legend.position = "top",
    axis.text.y = element_text(size = 10),
    panel.grid.minor.x = element_blank(),
    axis.ticks.x = element_blank(), 
    legend.justification = "left",
    strip.text = element_text(face = "bold"),
    legend.background = element_rect(
      fill = "gray95", color = "transparent"
    ),
    axis.text.x = element_text(size = 9)
  )
```

