---
title: "Índice de Transparência nos Ministérios Públicos"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(tidy = FALSE, 
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 10,
                      fig.width = 8)
set.seed(1014)
options(digits = 2, scipen = 999, OutDec = ",")


Sys.setenv(LANGUAGE = "pt-br")

```

```{r echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(hrbrthemes)
library(ggbeeswarm)
library(lubridate)
library(here)
library(waffle)

# peguei as cores do site e criei um vetor com nomes fáceis de lembrar
cores_dadosjusbr <- c(
  lilas = "#B361C6",
  cyan = "#2FBB96",
  cinza_azulado = "#3e5363",
  verde = "#96ba2f",
  laranja = "#F2C94C"
)

cores_natureza <- c(
  "Desconto" = cores_dadosjusbr[["lilas"]],
  "Recebimento" = cores_dadosjusbr[["cyan"]]
)

cores_indice <- c(
  "Transparência" = cores_dadosjusbr[["cyan"]],
  "Completude" = cores_dadosjusbr[["laranja"]],
  "Facilidade" = cores_dadosjusbr[["lilas"]]
)

theme_set(
  theme_ipsum_rc() +
  theme(
    axis.ticks.x = element_line(),
    plot.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]], size = 14),
    plot.subtitle = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    strip.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]])
  )
)

update_geom_font_defaults(color = cores_dadosjusbr[["cinza_azulado"]])
```

```{r}
estrutura <- function() {
  full <- cols(
    orgao = col_character(),
    receita_base = col_character(),
    despesas = col_character(),
    outras_receitas = col_character(),
    acesso = col_character(),
    ano = col_integer(),
    mes = col_integer(),
    acesso_i = col_integer(),
    indice_completude = col_double(), 
    indice_facilidade = col_double(),
    indice_transparencia = col_double(),
    tem_lotacao = col_logical(),
    tem_cargo = col_logical(),
    tem_matricula = col_logical(),
    nao_requer_login = col_logical(),
    nao_requer_captcha = col_logical(),
    formato_consistente = col_logical(),
    estritamente_tabular = col_logical()
  )
  media <- cols(
    orgao = col_character(),
    media_indice_completude = col_double(),
    media_indice_facilidade = col_double(),
    media_indice_transparencia = col_double()
  )
  
  return(list(full = full, media = media))
}

col_defs <- estrutura()

indice <- "data/load" %>% 
  here() %>%
  list.files(pattern = "^indice_transparencia.*_2022_02_08",
             full.names = TRUE) %>% 
  set_names(c("full", "media")) %>%
  map2(col_defs, ~ read_csv(.x, col_types = .y))

# vamos recalcular os índices
indice$full <- indice$full %>% 
  # select(-indice_completude,
  #        -indice_facilidade,
  #        -indice_transparencia) %>% 
  filter(str_detect(orgao, "^mp")) %>% 
  mutate(orgao = toupper(orgao) %>% str_replace("^MP", "MP-"))
```

## Índice de Facilidade

### Acesso

- **Acesso direto**: Conseguimos prever/construir uma URL com base no órgão/mês/ano que leve ao download do dado. Pode ser diretamente ou via API.
- **Amigavel para raspagem**: Aqui temos URLs determinísticas, tags usadas com semântica bem-definida 
- **Raspagem dificultada**: URLs não determinísticas, tags com semântica difusa (dois componentes com mesmo id)
- **Necessita simulação de usuário**: Não dá para fazer raspagem e precisou usar webdriver ou coisa do tipo

```{r fig.height=8, fig.width=10}
indice$full %>% 
  select(orgao, ano, mes, acesso, indice_facilidade) %>%
  mutate(acesso = replace_na(acesso, "Raspagem não possível")) %>% 
  complete(orgao, ano, mes, fill = list(
    acesso = "Dados não existem", indice_facilidade = NA
  )) %>%
  mutate(
    data = dmy(str_glue("01-{mes}-{ano}")),
    mes = month.abb[month(data)],
    acesso = acesso %>% 
      str_to_sentence() %>% 
      str_replace_all("Amigavel", "Amigável") %>% 
      str_replace_all("simulacao", "simulação") %>% 
      str_replace_all("usuario", "de usuário") %>% 
      str_replace_all("_", " ") %>%  
      ordered(levels = c(
        "Amigável para raspagem",
        "Necessita simulação de usuário",
        "Raspagem dificultada",
        "Raspagem não possível",
        "Dados não existem"
      )), #) %>%  count(acesso),
    ord = case_when(
      acesso == "Amigável para raspagem" ~ 4,
      acesso == "Necessita simulação de usuário" ~ 3,
      acesso == "Raspagem dificultada" ~ 1,
      acesso == "Raspagem não possível" ~ .25,
      TRUE ~ 0
  )) %>% 
  add_count(orgao, wt = ord, name = "ord_orgao") %>% 
  ggplot(aes(y = reorder(orgao, ord_orgao), x = data, fill = acesso)) +
  geom_tile(color = "gray90") +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x") +
  scale_fill_manual(values = c(
      "Amigável para raspagem" = cores_dadosjusbr[["cyan"]],
      "Necessita simulação de usuário" = cores_dadosjusbr[["laranja"]],
      "Raspagem dificultada" = cores_dadosjusbr[["lilas"]],
      "Raspagem não possível" = cores_dadosjusbr[["cinza_azulado"]],
      "Dados não existem" = "gray50"
    )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    fill = "Forma de acesso",
    title = "Classificação da forma de acesso para dados de remuneração\nnos Ministérios Públicos",
    subtitle = "Acessibilidade dos dados verificadas mês a mês",
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(legend.position = "top",
        legend.justification = "left") +
  guides(fill = guide_legend(ncol = 1, title.position = "top"))
```

