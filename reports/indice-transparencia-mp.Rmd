---
title: "Índice de Transparência nos Ministérios Públicos"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE,message=FALSE,warning=FALSE}
knitr::opts_chunk$set(tidy = FALSE, 
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.height = 8,
                      fig.width = 9)
set.seed(1014)
options(digits = 2, scipen = 999, OutDec = ",")


Sys.setenv(LANGUAGE = "pt-br")

```

```{r echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(hrbrthemes)
library(ggbeeswarm)
library(lubridate)
library(here)
library(waffle)

# peguei as cores do site e criei um vetor com nomes fáceis de lembrar
cores_dadosjusbr <- c(
  lilas = "#B361C6",
  cyan = "#2FBB96",
  cinza_azulado = "#3e5363",
  verde = "#96ba2f",
  laranja = "#F2C94C"
)

cores_natureza <- c(
  "Desconto" = cores_dadosjusbr[["lilas"]],
  "Recebimento" = cores_dadosjusbr[["cyan"]]
)

cores_indice <- c(
  "Transparência" = cores_dadosjusbr[["cyan"]],
  "Completude" = cores_dadosjusbr[["laranja"]],
  "Facilidade" = cores_dadosjusbr[["lilas"]]
)

theme_set(
  theme_ipsum_rc() +
  theme(
    axis.ticks.x = element_line(),
    plot.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]], size = 14),
    plot.subtitle = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.text.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.x = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    axis.title.y = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    legend.title = element_text(color = cores_dadosjusbr[["cinza_azulado"]]),
    strip.text = element_text(color = cores_dadosjusbr[["cinza_azulado"]])
  )
)

update_geom_font_defaults(color = cores_dadosjusbr[["cinza_azulado"]])
```

```{r}
col_defs <- cols(
    orgao = col_character(),
    ano = col_integer(),
    mes = col_integer(),
    tem_lotacao = col_logical(),
    tem_cargo = col_logical(),
    tem_matricula = col_logical(),
    receita_base = col_character(),
    despesas = col_character(),
    outras_receitas = col_character(),
    nao_requer_login = col_logical(),
    nao_requer_captcha = col_logical(),
    acesso = col_character(),
    formato_consistente = col_logical(),
    estritamente_tabular = col_logical(),
    acesso_i = col_double(),
    indice_completude = col_double(), 
    indice_facilidade = col_double(),
    indice_transparencia = col_double()
  )

indice <- "data/load/indice_transparencia_2022_02_11.csv" %>% 
  here() %>%
  read_csv(col_types = col_defs)

# vamos recalcular os índices
indice <- indice %>% 
  # select(-indice_completude,
  #        -indice_facilidade,
  #        -indice_transparencia) %>% 
  filter(str_detect(orgao, "^mp")) %>% 
  mutate(orgao = toupper(orgao) %>% str_replace("^MP", "MP-"))
```

## Órgãos que não estão sendo coletados

Os órgãos abaixo não estão sendo coletados devido a problemas de disponíbilidade e acesso causados pelos próprios órgãos (mudança de formato, alta complexidade para extração, inconsistências, etc.)

- MP-RJ
- MP-RS
- MP-PA
- MP-SC
- MP-ES
- MP-MA
- MP-AC
- MP-RR

## Índice de Facilidade

- Necessidade de login
- Necessário captcha
- Formato de acesso
- Manteve consistência no formato
- Formato estritamente tabular

### Necessidade de login

**Definição**: A necessidade de fornecimento de informações pessoais e autenticação para acesso dos dados. Requrer é o pior caso.

**Valores**:

- $1,00$: não requer login
- $0,00$: requer login

```{r fig.height=7}
indice %>%
  transmute(
    orgao, nao_requer_login,
    nao_requer_login_status = if_else(
      nao_requer_login,
      "Não requer login",
      "Dado não disponível (Erro status 4)"
    ),
    indice_facilidade,
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>%
  complete(
    orgao, data, fill = list(
      nao_requer_login_status = "Dado não disponível",
      nao_requer_login = FALSE
  )) %>%
  mutate(
    nao_requer_login_status = ordered(
      nao_requer_login_status,
      levels = c(
        "Não requer login",
        "Requer login",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, nao_requer_login, sum),
    fill = nao_requer_login_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer login" = cores_dadosjusbr[["cyan"]],
    "Requer login" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Requer Login para acesso aos dados",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Necessário Captcha

**Definição**: Verificação se o acesso está sendo feito por humanos.

**Valores**:

- $1,00$: não requer captcha
- $0,00$: requer captcha

```{r fig.height=7}
indice %>%
  transmute(
    orgao, nao_requer_captcha,
    nao_requer_captcha_status = if_else(
      nao_requer_captcha,
      "Não requer captcha",
      "Dado não disponível (Erro status 4)"
    ),
    indice_facilidade,
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>%
  complete(
    orgao, data, fill = list(
      nao_requer_captcha_status = "Dado não disponível",
      nao_requer_captcha = FALSE
  )) %>%
  mutate(
    nao_requer_captcha_status = ordered(
      nao_requer_captcha_status,
      levels = c(
        "Não requer captcha",
        "Requer captcha",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, nao_requer_captcha, sum),
    fill = nao_requer_captcha_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Não requer captcha" = cores_dadosjusbr[["cyan"]],
    "Requer captcha" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Requer captcha para acesso aos dados",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Acesso

**Definição**: Se é possível acessar os dados programaticamente através de URLs que seguem boas práticas, se é necessário raspar os dados de maneira fácil (pois páginas e URLs têm boas práticas de estrutura), se é necessário raspagem complexa ou se é necessário simular um usuário usando um navegador (pior caso).

**Valores**:

- $1,00$: o acesso é feito de forma **DIRETA**, através de URLs que seguem boas práticas
- $0,50$: o acesso é **AMIGAVEL PARA RASPAGEM**
- $0,25$: o acesso **NÃO É AMIGAVEL PARA RASPAGEM**
- $0,00$: é **NECESSÁRIO SIMULAÇÃO DE USUÁRIO** para acesso

```{r fig.height=8}
acesso <- indice %>% 
  select(orgao, ano, mes, acesso, indice_facilidade) %>%
  mutate(
    pontuacao_acesso = case_when(
      acesso == "DIRETA" ~ 1,
      acesso == "AMIGAVEL_PARA_RASPAGEM" ~ 0.5,
      acesso == "RASPAGEM_DIFICULTADA" ~ 0.25,
      acesso == "NECESSITA_SIMULACAO_USUARIO" ~ 0
      ),
    acesso = acesso %>% 
      str_to_sentence() %>% 
      str_replace_all("Amigavel", "Amigável") %>% 
      str_replace_all("simulacao", "simulação") %>% 
      str_replace_all("usuario", "de usuário") %>% 
      str_replace_all("_", " ") %>% 
      replace_na("Dado indisponível (status 4)")
  ) %>% 
  complete(orgao, ano, mes,
           fill = list(acesso = "Dado indisponível")) %>% 
  mutate(
    data = dmy(str_glue("01-{mes}-{ano}")),
    mes = month.abb[month(data)],
    acesso = ordered(acesso, levels = c(
      "Direta",
      "Amigável para raspagem",
      "Raspagem dificultada",
      "Necessita simulação de usuário",
      "Dado indisponível (status 4)",
      "Dado indisponível"
  )))
```

```{r fig.height=8, fig.width=9}
acesso %>% 
  ggplot(aes(
    y = reorder(orgao, pontuacao_acesso, sum, na.rm = TRUE),
    x = data, 
    fill = acesso
  )) +
  geom_tile(color = "gray90") +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x") +
  scale_fill_manual(values = c(
    "Direta" = cores_dadosjusbr[["verde"]],
    "Amigável para raspagem" = cores_dadosjusbr[["cyan"]],
    "Raspagem dificultada" = cores_dadosjusbr[["lilas"]],
    "Necessita simulação de usuário" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado indisponível (status 4)" = "red",
    "Dado indisponível" = cores_dadosjusbr[["laranja"]]
  ), drop=FALSE) +
  scale_y_discrete() +
  scale_x_date(expand = c(0, 0)) +
  labs(
    fill = "Forma de acesso",
    title = "Classificação da forma de acesso",
    subtitle = "Ministérios Públicos - mês a mês",
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(legend.position = "top",
        legend.justification = "left") +
  guides(fill = guide_legend(ncol = 1, title.position = "top"))
```

```{r fig.height=10, fig.width=9}
acesso %>% 
  select(-data) %>% 
  na.omit() %>% 
  group_by(orgao, ano) %>% 
  summarise(across(where(is.double), mean, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(-c(orgao, ano), names_to = "indice", values_to = "valor") %>% 
  mutate(ord = if_else(indice == "indice_facilidade", valor, NA_real_)) %>% 
  fill(ord, .direction = "down") %>% 
  mutate(
    indice = if_else(indice == "indice_facilidade",
                     "Índice de Facilidade", 
                     "Pontuação Acesso")
  ) %>% 
  ggplot(aes(
    x = tidytext::reorder_within(orgao, ord, ano, sum),
    y = valor,
    color = indice,
    group = orgao
  )) +
  coord_flip() +
  scale_color_manual(values = c(
    "Índice de Facilidade" = cores_dadosjusbr[["lilas"]],
    "Pontuação Acesso" = cores_dadosjusbr[["cinza_azulado"]]
  ), guide = guide_legend(reverse = TRUE)) +
  scale_size_manual(values = c(3, 1),
                    guide = guide_legend(reverse = TRUE)) +
  facet_wrap(~ ano, scales = "free") +
  geom_line(color = "gray80", size = 1.5) +
  geom_point(aes(size = indice)) +
  # geom_text(
  #   data = . %>% filter(indice == "Índice de Facilidade"),
  #   aes(label = orgao),
  #   color = "black",
  #   hjust = -0.3,
  #   size = 3
  # ) +
  scale_y_continuous(limits = c(0, 1)) +
  tidytext::scale_x_reordered() +
  labs(x = "Órgão",
       y = "Pontuação",
       color = NULL,
       size = NULL,
       title = "Índice de Facilidade vs Pontuação de Acesso (2018-2021)",
       subtitle = "Média anual por órgão",
       caption = str_glue("Classificações quanto ao acesso:\n",
                          "Direto: 1p\n",
                          "Amigável para raspagem: 0,5p\n",
                          "Não é amigável para raspagem: 0,25\n",
                          "Necessário simulação de usuário: 0,p")
       ) +
  theme(
    legend.position = "top",
    plot.caption = element_text(hjust = 0),
    axis.text.y = element_text(size = 9),
    panel.grid.minor.x = element_blank(),
    axis.ticks.x = element_blank(), 
    legend.justification = "left",
    strip.text = element_text(face = "bold"),
    legend.background = element_rect(
      fill = "gray95", color = "transparent"
    ),
    axis.text.x = element_text(size = 9)
  )
```

### Manteve consistência do formato

**Definição**: Esse campo captura se houve mudanças no formato como os dados que foram disponibilizados.

**Valores**:

- $1,00$: quando o formato é consistente
- $0,00$: quando o formato não é consistente


```{r fig.height=7}
indice %>%
  #filter(orgao == "MP-PB", ano == 2021, mes == 12) %>% glimpse()
  transmute(
    orgao, formato_consistente,
    formato_consistente_status = case_when(
      formato_consistente & !is.na(acesso) ~ "Consistente",
      !formato_consistente & is.na(acesso) ~ "Dado não disponível (Erro status 4)",
      TRUE ~ "Inconsistente"
    ),
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>%
  complete(
    orgao, data, fill = list(
      formato_consistente_status = "Dado não disponível",
      formato_consistente = FALSE
  )) %>%
  mutate(
    formato_consistente_status = ordered(
      formato_consistente_status,
      levels = c(
        "Consistente",
        "Inconsistente",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, formato_consistente, sum),
    fill = formato_consistente_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Consistente" = cores_dadosjusbr[["cyan"]],
    "Inconsistente" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Manteve consistência do formato",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Formato estritamente tabular

**Definição**: Os dados estão em formato que permite importação direta em software de análise ou precisam ser processados primeiro (por ex. por estarem em um doc ou pdf).

**Valores**:

- $1,00$: quando o formato é estritamente tabular
- $0,00$: quando o formato não é estritamente tabular

```{r fig.height=7}
indice %>%
  #filter(orgao == "MP-PB", ano == 2021, mes == 12) %>% glimpse()
  transmute(
    orgao, estritamente_tabular,
    estritamente_tabular_status = case_when(
      estritamente_tabular & !is.na(acesso) ~ "Estritamente tabular",
      !estritamente_tabular & is.na(acesso) ~ "Dado não disponível (Erro status 4)",
      TRUE ~ "Não tabular"
    ),
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>%
  complete(
    orgao, data, fill = list(
      estritamente_tabular_status = "Dado não disponível",
      estritamente_tabular = FALSE
  )) %>%
  mutate(
    estritamente_tabular_status = ordered(
      estritamente_tabular_status,
      levels = c(
        "Estritamente tabular",
        "Não tabular",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, estritamente_tabular, sum),
    fill = estritamente_tabular_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Estritamente tabular" = cores_dadosjusbr[["cyan"]],
    "Não tabular" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Formato estritamente tabular",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

## Índice de Completude

- Nome e matrícula
- Lotação
- Cargo
- Remuneração básica
- Outras receitas
- Detalhamento de despesas

### Nome e matrícula

**Definição**: Nome e número de identificação do funcionário

**Valores**:

- $1,00$: possui ambos os atributos
- $0,00$: não possui um dos atributos 

```{r}
indice %>% #glimpse()
  transmute(
    orgao, tem_matricula,
    tem_matricula_status = case_when(
      tem_matricula ~ "Possui nome e matrícula", 
      !tem_matricula & !is.na(acesso) ~ "Não possui nome e matrícula",
      TRUE ~ "Dado não disponível (Erro status 4)"
    ),
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>% 
  complete(
    orgao, data, fill = list(
      tem_matricula_status = "Dado não disponível",
      tem_matricula = FALSE
  )) %>%
  mutate(
    tem_matricula_status = ordered(
      tem_matricula_status,
      levels = c(
        "Possui nome e matrícula",
        "Não possui nome e matrícula",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, tem_matricula, sum),
    fill = tem_matricula_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui nome e matrícula" = cores_dadosjusbr[["cyan"]],
    "Não possui nome e matrícula" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Possui nome e matrícula",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Lotação

**Definição**: local onde o sercidor exerce as atribuições e responsabilidades do cargo público.

**Valores**:

- $1,00$: possui o atributo lotação
- $0,00$: não possui o atributo lotação 

```{r}
indice %>% #glimpse()
  transmute(
    orgao, tem_lotacao,
    tem_lotacao_status = case_when(
      tem_lotacao ~ "Possui lotação", 
      !tem_lotacao & !is.na(acesso) ~ "Não possui lotação",
      TRUE ~ "Dado não disponível (Erro status 4)"
    ),
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>% 
  complete(
    orgao, data, fill = list(
      tem_lotacao_status = "Dado não disponível",
      tem_lotacao = FALSE
  )) %>%
  mutate(
    tem_lotacao_status = ordered(
      tem_lotacao_status,
      levels = c(
        "Possui lotação",
        "Não possui lotação",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, tem_lotacao, sum),
    fill = tem_lotacao_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui lotação" = cores_dadosjusbr[["cyan"]],
    "Não possui lotação" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Possui lotação",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Cargo

**Definição**: função que o servidor exerce no órgão.

**Valores**:

- $1,00$: possui o atributo cargo
- $0,00$: não possui o atributo cargo 

```{r}
indice %>% #glimpse()
  transmute(
    orgao, tem_cargo,
    tem_cargo_status = case_when(
      tem_cargo ~ "Possui atributo cargo", 
      !tem_cargo & !is.na(acesso) ~ "Não possui atributo cargo",
      TRUE ~ "Dado não disponível (Erro status 4)"
    ),
    data = dmy(str_glue("01-{mes}-{ano}"))
  ) %>% 
  complete(
    orgao, data, fill = list(
      tem_cargo_status = "Dado não disponível",
      tem_cargo = FALSE
  )) %>%
  mutate(
    tem_cargo_status = ordered(
      tem_cargo_status,
      levels = c(
        "Possui atributo cargo",
        "Não possui atributo cargo",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data)
  ) %>%
  ggplot(aes(
    x = data,
    y = reorder(orgao, tem_cargo, sum),
    fill = tem_cargo_status
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Possui atributo cargo" = cores_dadosjusbr[["cyan"]],
    "Não possui atributo cargo" = cores_dadosjusbr[["lilas"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Possui atributo Cargo",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```

### Remuneração básica

**Definição**: para os Ministérios Públicos o valor da remuneração básica é composto pela soma do valor da remuneração do Cargo Efetivo e o valor correspondente a outras verbas remuneratórias, legais ou judiciais.

**Valores**: 

- $1,00$: apresenta remuneração básica **detalhada**
- $0,50$: apresenta remuneração básica **sumarizada**
- $0,00$: não apresenta remuneração básica

```{r}
pecunias <- function(df, my_colname) {
  
  newcolname <- glue::glue("{my_colname}_pontos")
  colname_complete <- str_remove(my_colname, "_pontos")
                                 
  pecunia <- case_when(
    newcolname == "despesas_pontos" ~ "despesas",
    newcolname == "receita_base_pontos" ~ "remuneração básica",
    newcolname == "outras_receitas_pontos" ~ "remunerações eventuais/temporárias"
  )
  
  df %>% 
    transmute(
      orgao, 
      data = dmy(str_glue("01-{mes}-{ano}")),
      !!sym(my_colname) := replace_na(!! sym(my_colname), "Dado não disponível (erro status 4)"),
      !!newcolname := case_when(
        !!sym(my_colname) == "DETALHADO" ~ 1,
        !!sym(my_colname) == "SUMARIZADO" ~ 0.5,
        TRUE ~ NA_real_
    )) %>% 
    complete(orgao, data) %>% 
    mutate(
      !!sym(my_colname) := replace_na(!!sym(my_colname), "Dado não disponível"),
      !!sym(newcolname) := replace_na(!!sym(newcolname), 0),
      !!sym(my_colname) := ordered(!!sym(my_colname), levels = c(
        "DETALHADO",
        "SUMARIZADO",
        "Dado não disponível",
        "Dado não disponível (erro status 4)"
      )),
      mes = month.abb[month(data)],
      ano = year(data)
    ) %>%
    ggplot(aes(
      x = data,
      y = reorder(orgao, !!sym(newcolname), sum),
      fill := !!sym(my_colname)
    )) +
    geom_tile(color = "gray90") +
    scale_fill_manual(values = c(
      "DETALHADO" = cores_dadosjusbr[["cyan"]],
      "SUMARIZADO" = cores_dadosjusbr[["lilas"]],
      "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
      "Dado não disponível (erro status 4)" = "red"
    )) +
    scale_x_date(expand = c(0, 0)) +
    labs(
      title = glue::glue("Detalhamento de {pecunia}"),
      subtitle = "Ministérios Públicos - mês a mês",
      fill = NULL,
      x = "Cada célula representa 1 mês",
      y = NULL
    ) +
    theme(
      legend.position = "top",
      legend.direction = "vertical",
      legend.justification = "left",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.spacing = unit(2, "mm"),
      strip.text = element_text(face = "bold")
    ) +
    guides(fill = guide_legend(ncol = 2)) +
    facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
  
}

pecunias(indice, "receita_base")
```

### Despesas

**Definição**: valor correspondentes a descontos obrigatórios como: Contribuição Previdenciária, Imposto de Renda e Retenção por Teto Constitucional

**Valores**: 

- $1,00$: apresenta despesas **detalhadas**
- $0,50$: apresenta despesas **sumarizadas**
- $0,00$: não apresenta despesas

```{r}
pecunias(indice, "despesas")
```

### Outras remunerações

**Despesas**: ínclui remuneração eventual ou temporária, tais como: função de confiança ou cargo em comissão, gratificação natalina, férias constitucionais, abono permanência, insalubridade, bem como as indenizações, por exemplo: pecúnias ou auxílios como: alimentação, saúde, creche, moradia, natalidade.

**Valores**: 

- $1,00$: apresenta outras receitas **detalhadas**
- $0,50$: apresenta outras receitas **sumarizadas**
- $0,00$: não apresenta outras receitas

```{r}
pecunias(indice, "outras_receitas")
```

### Detalhamento de remunerações em conjunto

```{r}
indice %>% 
  transmute(
    orgao, 
    receita_base,
    outras_receitas,
    despesas,
    data = dmy(str_glue("01-{mes}-{ano}")),
    remuneracoes = case_when(
      receita_base == "DETALHADO" & 
        outras_receitas == "DETALHADO" &
        despesas == "DETALHADO" ~ "Todas as remunerações e despess detalhadas",
      receita_base == "DETALHADO" & 
        outras_receitas == "DETALHADO" &
        despesas != "DETALHADO" ~ "Remunerações detalhadas, despesas sumarizadas",
      receita_base == "DETALHADO" & 
        despesas == "DETALHADO" &
        outras_receitas != "DETALHADO" ~ "Remunerações básicas e despesas detalhadas,\nremunerações eventuais/temporárias sumarizadas",
      TRUE ~ "Dado não disponível (Erro status 4)"
  )) %>% 
  complete(
    orgao, data, fill = list(
      receita_base = NA,
      outras_receitas = NA,
      despesas = NA,
      remuneracoes = "Dado não disponível"
  )) %>% 
  mutate(
    remuneracoes = ordered(
      remuneracoes,
      levels = c(
        "Todas as remunerações e despess detalhadas",
        "Remunerações detalhadas, despesas sumarizadas",
        "Remunerações básicas e despesas detalhadas,\nremunerações eventuais/temporárias sumarizadas",
        "Dado não disponível",
        "Dado não disponível (Erro status 4)"
      )),
    mes = month.abb[month(data)],
    ano = year(data),
    receita_base = case_when(
      receita_base == "DETALHADO" ~ 1,
      receita_base == "SUMARIZADO" ~ 0.5,
      TRUE ~ 0),
    outras_receitas = case_when(
      outras_receitas == "DETALHADO" ~ 1,
      outras_receitas == "SUMARIZADO" ~ 0.5,
      TRUE ~ 0),
    despesas = case_when(
      despesas == "DETALHADO" ~ 1,
      despesas == "SUMARIZADO" ~ 0.5,
      TRUE ~ 0),
    remuneracao_pontos = receita_base + outras_receitas + despesas
  ) %>% 
  ggplot(aes(
    x = data,
    y = reorder(orgao, remuneracao_pontos, sum),
    fill = remuneracoes
  )) +
  geom_tile(color = "gray90") +
  scale_fill_manual(values = c(
    "Todas as remunerações e despess detalhadas" = cores_dadosjusbr[["cyan"]],
    "Remunerações detalhadas, despesas sumarizadas" = cores_dadosjusbr[["lilas"]],
    "Remunerações básicas e despesas detalhadas,\nremunerações eventuais/temporárias sumarizadas" =
      cores_dadosjusbr[["laranja"]],
    "Dado não disponível" = cores_dadosjusbr[["cinza_azulado"]],
    "Dado não disponível (Erro status 4)" = "red"
  )) +
  scale_x_date(expand = c(0, 0)) +
  labs(
    title = "Detalhamento de remunerações e despesas",
    subtitle = "Ministérios Públicos - mês a mês",
    fill = NULL,
    x = "Cada célula representa 1 mês",
    y = NULL
  ) +
  theme(
    legend.position = "top",
    legend.direction = "vertical",
    legend.justification = "left",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2, "mm"),
    strip.text = element_text(face = "bold")
  ) +
  guides(fill = guide_legend(ncol = 2)) +
  facet_wrap(ano ~ ., nrow = 1, scales = "free_x")
```
